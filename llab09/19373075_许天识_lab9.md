## lab08函数

#### 学号：19373075

#### 姓名：许天识

## 思路方法

本质上函数也是一个标识变量，存在符号表内，但需要额外保存相关信息：返回值类型、参数个数、各个参数格式等。由于采用一维数组模拟高维数组，参数只有变量和一维数组两个类型。

可以将工作分为2部分：函数定义和函数调用。

## 具体细节

#### 函数定义

函数类如下，保存函数名字，函数是否有返回值，以及函数的所有形式参数。

```java
public class Func {
    private String name;
    private ArrayList<StackElement> params;
    private boolean has_return;
}
```

在函数定义时，形参逐个识别保存。

在函数定义结束时，要干两件事：

​	（1）将该函数压入符号栈，同时新建一块符号栈索引，表示函数内部区域。

​	（2）将形式参数作为函数内部的局部变量压入符号表中，其中如果是普通变量还需要allocat一个空间保存再load，以使得该参数变量可以被修改，数组已经是一个指针了，无需分配空间。

#### 函数调用

函数调用时，首先识别出名字，然后读取实参。接下来：

（1）比较参数个数是否一致，不一致报错

（2）普通变量实参很好处理，直接送入函数

（3）数组实参先判断维数是否小于等于形参，否则报错。然后，除第一维外，比较维度是否一致，否则报错。最后，根据实际维数算出一个新的数组，也就是实参转换而来的数组，它有自己的维度、各维度长度信息，作为一个地址传入函数。例如：

```
int a[2][3][4][5]
fun(a[1][2])
//此时a[1][2]就相当于一个新的数组
```

而在所有真正使用到数组的地方都是一维数组调用（即根据各维度坐标算出一维中的总坐标），多维信息仅用于检查该数组是否正确使用。

## 巨坑点

ret语句之后不能有任何语句！！！采取的方法是进行特判，br前如果有ret语句则不进行br，同时如果br前所有分支均ret了，那么不应该开辟新的代码块！！！
